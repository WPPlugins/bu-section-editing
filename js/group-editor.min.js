jQuery(document).ready(function(b){var p;"undefined"!==typeof bu&&"undefined"!==typeof bu.plugins.navigation&&"undefined"!==typeof bu.plugins.navigation.tree&&(p=bu.plugins.navigation);var q=b("#group-member-list");b("a.nav-link").click(function(a){a.preventDefault();a=b('a.nav-tab[href="'+this.hash+'"]');var c=b(this.hash);$input=c.hasClass("group-panel")?b("#tab"):b("#perm_panel");$input.val(a.data("target"));a.addClass("nav-tab-active").siblings().removeClass("nav-tab-active");c.addClass("active").siblings().removeClass("active")});
b("#edit-group-name").blur(function(a){a=b.trim(b(this).val());60<a.length&&(a=a.slice(0,59),b(this).val(a));if(1>a.length)return k(buse_group_editor_settings.nameRequiredNotice),!1;t();b("#group-stats-name").html(a)});b(".member:not(.active)").appendTo("#inactive-members");q.delegate("a.remove_member","click",function(a){a.preventDefault();b(this).parent(".member").removeClass("active").slideUp("fast",function(){b(this).appendTo("#inactive-members").find('input[type="checkbox"]').removeAttr("checked");
u()})});var E=function(){return b.map(b('li.member.active input[type="checkbox"]'),function(a){return parseInt(a.value,10)})},F=function(a,c){return b.grep(a,function(a,b){c=c.toLowerCase();return a.user.is_section_editor&&(-1!=a.user.display_name.toLowerCase().indexOf(c)||-1!=a.user.login.toLowerCase().indexOf(c)||-1!=a.user.nicename.toLowerCase().indexOf(c)||-1!=a.user.email.toLowerCase().indexOf(c))})},G=function(a){return b.grep(a,function(a,d){return!v(a.user)})},v=function(a){var c=E();return-1<
b.inArray(a.id,c)},H=function(a){var c=b.grep(buse_site_users,function(d,b){var c=a.toLowerCase();return d.user.display_name.toLowerCase()==c||d.user.login.toLowerCase()==c||d.user.nicename.toLowerCase()==c||d.user.email.toLowerCase()==c});return 1<c.length||0==c.length?!1:c[0].user},I=b(".buse-suggest-user").autocomplete({source:function(a,c){var d=F(buse_site_users,a.term),d=G(d),d=b.map(d,function(a){return a.autocomplete});c(d)},delay:500,minLength:2,position:"undefined"!==typeof isRtl&&isRtl?
{my:"right top",at:"right bottom",offset:"0, -1"}:{offset:"0, -1"},open:function(){b(this).addClass("open")},close:function(){b(this).removeClass("open")}});b("#add_member").bind("click",function(a){a.preventDefault();w()});b("#user_login").keypress(function(a){"13"==a.keyCode&&(a.preventDefault(),w())});var w=function(){var a=b.trim(b("#user_login").val());if(a){I.autocomplete("search","");var c=H(a);c?c.is_section_editor?v(c)?(a="<b>"+c.display_name+"</b> "+b("<p/>").html(buse_group_editor_settings.userAlreadyMemberNotice).text(),
k(a,"members-message")):(t("members-message"),b("#member_"+c.id).attr("checked","checked").parent(".member").addClass("active").appendTo(q).slideDown("fast"),u()):(a="<b>"+c.display_name+"</b> "+b("<p/>").html(buse_group_editor_settings.userWrongRoleNotice).text(),k(a,"members-message")):(a="<b>"+a+"</b> "+b("<p/>").html(buse_group_editor_settings.userNotExistsNotice).text(),k(a,"members-message"))}b("#user_login").val("").focus()},u=function(){var a,c;a=q.children(".member").length;c=1==a?buse_group_editor_settings.memberCountSingularLabel:
buse_group_editor_settings.memberCountPluralLabel;b(".member-count").html(a);b(".member-count-label").text(c)},x=function(a){var c=a.find(".perm-editor").first();c.hasClass("hierarchical")?"undefined"===typeof p?(alert(buse_group_editor_settings.navDepAlertText),c.html(buse_group_editor_settings.navDepEditorText)):J(c):K(c);L(a,c);c.delegate(".edit-perms","click",function(a){var e=b(a.currentTarget),f=e.closest("li"),e=e.attr("class"),g;a.stopPropagation();a.preventDefault();-1<e.indexOf("allowed")?
g="allowed":-1<e.indexOf("denied")&&(g="denied");l(f,"allowed"==g?!0:!1,c);c.trigger("perm_updated",[{post:f,action:g}])});b(document).bind("click",function(a){var c=b(".perm-panel.active"),f=b(".perm-editor",c);b.contains(c[0],a.target)||(f.hasClass("hierarchical")&&"undefined"!==typeof f.jstree?f.jstree("deselect_all"):f.find(".perm-item-selected").removeClass("perm-item-selected"))});a.addClass("loaded")};b("#perm-tab-container").delegate("a","click",function(a){a=b(b(this).attr("href"));a.hasClass("loaded")||
x(a)});var L=function(a,c){a.delegate("button.perm-search","click",function(a){a.preventDefault();a=c.data("post-type");a=b("#perm-search-"+a).val();a={post_type:c.data("post-type"),query:{s:a}};r(c,a)});a.find(".pagination-links").delegate("a","click",function(a){a.preventDefault();if(!b(this).hasClass("disabled")){a=b(this).attr("class");var e=parseInt(b(this).parent().find(".current-page").val()),f=parseInt(b(this).parent().find(".total-pages").text()),g=1;switch(a){case "first-page":g=1;break;
case "prev-page":g=e-1;break;case "next-page":g=e+1;break;case "last-page":g=f}y(g,c)}});a.delegate("input.current-page","keypress",function(a){if("13"==a.keyCode){a.preventDefault();a=b(this).val();var e=parseInt(b(this).parent().find(".total-pages").text());1>a?b(this).val(1):a>e&&b(this).val(e);a=b(this).val();y(a,c)}});a.delegate("input.perm-search","keypress",function(a){13==a.keyCode&&(a.preventDefault(),b(this).siblings("button").first().click())});a.delegate("a.perm-editor-bulk-edit","click",
function(d){d.preventDefault();d=b(this);a.hasClass("bulk-edit")?(d.removeClass("bulk-edit-close").attr("title",buse_group_editor_settings.bulkEditOpenTitle).text(buse_group_editor_settings.bulkEditOpenText),a.removeClass("bulk-edit")):(d.addClass("bulk-edit-close").attr("title",buse_group_editor_settings.bulkEditCloseTitle).text(buse_group_editor_settings.bulkEditCloseText),a.addClass("bulk-edit"));c.find(".perm-item-selected").removeClass("perm-item-selected");a.find('input[type="checkbox"]').attr("checked",
!1);b(".bulk-edit-actions select").val("none")});a.delegate(".bulk-edit-select-all","click",function(a){c.find("li").children('input[type="checkbox"]').attr("checked",this.checked)});a.delegate(".bulk-edit-actions button","click",function(d){d.preventDefault();d=b(this).siblings("select");var e=d.val(),f=c.find('input[type="checkbox"]:checked');0<f.length&&("allowed"!=e&&"denied"!=e||f.each(function(){var a=b(this).parents("li");l(a,"allowed"==e?!0:!1,c)}));a.find(".bulk-edit-select-all").attr("checked",
!1);d.val("none");f.attr("checked",!1)});a.delegate("a.perm-tree-expand","click",function(a){a.preventDefault();"undefined"!==typeof b.jstree&&b.jstree._reference(c).open_all()});a.delegate("a.perm-tree-collapse","click",function(a){a.preventDefault();"undefined"!==typeof b.jstree&&b.jstree._reference(c).close_all()})},y=function(a,c){var d=c.closest(".perm-panel"),e=c.data("post-type"),f={post_type:e,query:{paged:a}},e=b("#perm-search-"+e).val();0<e.length&&(f.query.s=e);d.find(".bulk-edit-select-all").attr("checked",
!1);d.find(".bulk-edit-actions select").val("none");r(c,f)},M=function(a){var c=a.hasClass("allowed")?"allowed":"denied",b="allowed"==c?"denied":"allowed",e="",e="allowed"==b?buse_group_editor_settings.permAllowLabel:buse_group_editor_settings.permDenyLabel;a.removeClass(c).addClass(b).text(e)},K=function(a){var b=a.data("post-type");N(a);a.bind("posts_loaded.buse",function(b,c){var f=a.data("perm-edits")||{allowed:[],denied:[]},g,h;for(g=0;g<f.allowed.length;g+=1)h=f.allowed[g],h=a.find("#p"+h),
h.length&&l(h,!0,a);for(g=0;g<f.denied.length;g+=1)h=f.denied[g],h=a.find("#p"+h),h.length&&l(h,!1,a)});r(a,{post_type:b})},N=function(a){a.delegate("a","click",function(a){a.preventDefault();a.stopPropagation();a=b(this).parent("li").first();a.siblings("li.perm-item-selected").each(function(){b(this).removeClass("perm-item-selected")});a.addClass("perm-item-selected")});a.bind("perm_updated",function(a,b){b.post.removeClass("perm-item-selected")})},J=function(a){var c={el:"#"+a.attr("id"),groupID:b("#group_id").val()||
-1,postType:a.data("post-type")};b.extend(c,buse_perm_editor_settings);p.tree("buse_perm_editor",c);a.bind("load_node.jstree",function(a,b){-1!=b.rslt.obj&&z(b.rslt.obj)}).bind("perm_updated",function(b,c){var f=c.post;f.hasClass("jstree-closed")&&a.jstree("open_all",f);a.jstree("deselect_node",f)})},r=function(a,c){var d={action:"buse_render_post_list",group_id:b("#group_id").val()||-1,query:{}};b.extend(d,c);a.addClass("loading");d.query.offset?a.append('<li class="loader">'+buse_group_editor_settings.loadingText+
"</li>"):a.html('<ul><li class="loader">'+buse_group_editor_settings.loadingText+"</li></ul>");b.ajax({url:ajaxurl,type:"GET",data:d,cache:!1,success:function(c){d.query.offset?a.append(c.posts):a.html(c.posts);var f=c.page,g=c.found_posts,h=c.max_num_pages,k=a.data("post-type");b("#group_id").val();$pagination=b("#perm-editor-pagination-"+k);$total_items=$pagination.find(".displaying-num");$current_page=$pagination.find(".current-page");$total_pages=$pagination.find(".total-pages");$first_page=$pagination.find(".first-page");
$prev_page=$pagination.find(".prev-page");$next_page=$pagination.find(".next-page");$last_page=$pagination.find(".last-page");1<h?(k=1==parseInt(g)?" item":" items",$total_items.text(g+k),$current_page.val(f),$total_pages.text(h),1==f?($first_page.addClass("disabled"),$prev_page.addClass("disabled")):($first_page.removeClass("disabled"),$prev_page.removeClass("disabled")),f==h?($next_page.addClass("disabled"),$last_page.addClass("disabled")):($next_page.removeClass("disabled"),$last_page.removeClass("disabled")),
$pagination.show()):$pagination.hide();a.trigger("posts_loaded.buse",{posts:c.posts});a.removeClass("loading")},error:function(a){}})},l=function(a,c,d){var e=d.data("post-type"),f=d.data("perm-edits")||{allowed:[],denied:[]};A(a,c,f);d.hasClass("hierarchical")&&(a=a.parent("ul").parent("div").attr("id")!=d.attr("id")?a.parents("li:last"):a,z(a));d.data("perm-edits",f);f=b("#"+e+"-stats");d=b(".perm-stats-diff",f);e=b("#perm-editor-"+e).data("perm-edits");0===d.length&&(d=b('<span class="perm-stats-diff"></span>'),
f.append(d));var f=[],g;for(g in e)e[g].length&&(a="allowed"===g?"+":"-",f.push('<span class="'+g+'">'+a+e[g].length+"</span>"));(g=f.join(", "))?d.html(" ("+g+")"):d.html("")},A=function(a,c,d){var e=a.attr("id").substr(1),f=a.find(".edit-perms").first();c!=a.data("editable")&&M(f);var f=c?"allowed":"denied",g=a.data("editable-original");a.data("editable",c);a.attr("rel",f);g!=c?(g=b.inArray(e,d[f]),-1===g&&d[f].push(e)):(g=b.inArray(e,d.allowed),-1<g&&d.allowed.splice(g,1),g=b.inArray(e,d.denied),
-1<g&&d.denied.splice(g,1));a.find("> ul > li").each(function(){A(b(this),c,d)})},z=function(a){$sections=a.find("ul");$sections.each(function(){var a=b(this).parents("li").first();if(a.length){var d=!1;switch(a.attr("rel")){case "allowed":case "allowed-desc-denied":case "allowed-desc-unknown":(d=b(this).find('li[rel="denied"],li[rel="denied-desc-allowed"],li[rel="denied-desc-unknown"]').length)?a.attr("rel","allowed-desc-denied"):a.attr("rel","allowed");B(a,d);break;case "denied":case "denied-desc-allowed":case "denied-desc-unknown":(d=
b(this).find('li[rel="allowed"],li[rel="allowed-desc-denied"],li[rel="allowed-desc-unknown"]').length)?a.attr("rel","denied-desc-allowed"):a.attr("rel","denied"),B(a,d)}}})},B=function(a,c){var d=a.find("> a > .perm-stats"),e=a.data("editable");0===d.length&&(d=b(' <span class="perm-stats"><ins class="jstree-icon">&nbsp;</ins><span class="label"></span></span>'),a.find("> a > .title-count").after(d));d.removeClass("allowed denied").children(".label").text("");c&&(e?d.addClass("denied").children(".label").text(c+
" "+buse_group_editor_settings.permNonEditableLabel):d.addClass("allowed").children(".label").text(c+" "+buse_group_editor_settings.permEditableLabel))},k=function(a,c,d){var e={classes:"error",before_msg:"<p>",after_msg:"</p>"};d&&"object"==typeof d&&b.extend(e,d);b("#"+(c||"message")).attr("class",e.classes).html(e.before_msg+a+e.after_msg).fadeIn()},t=function(a){b("#"+(a||"message")).fadeOut("fast",function(a){b(this).attr("class","").html("")})},C,m;C=b("#edit-group-name").val();var D=function(){var a=
[];b("#group-member-list").children("li.member.active").each(function(c,d){a.push(b(d).children("input").first().val())});return a};m=D();window.onbeforeunload=function(){if(O())return buse_group_editor_settings.dirtyLeaverNotice};var O=function(){var a=!1,c,d,e;c=b("#edit-group-name").val();C!=c&&(a=!0);c=D();if(m.length!=c.length)a=!0;else for(e=0;e<m.length;e+=1)-1==b.inArray(m[e],c)&&(a=!0);b(".perm-editor").each(function(){d=b(this).data("perm-edits");"undefined"!==typeof d&&(d.allowed.length||
d.denied.length)&&(a=!0)});return a};b("#group-edit-form").submit(function(a){window.onbeforeunload=null;if(1>b.trim(b("#edit-group-name").val()).length)return k(buse_group_editor_settings.nameRequiredNotice),!1;b(".perm-editor").each(function(){var a=b(this).data("perm-edits")||{allowed:[],denied:[]};b(this).siblings(".buse-edits").val(JSON.stringify(a))})});b("a.submitdelete").click(function(a){a.preventDefault();confirm(buse_group_editor_settings.deleteGroupNotice+"\n\n"+buse_group_editor_settings.confirmActionNotice)&&
(window.onbeforeunload=null,window.location=b(this).attr("href"))});if(document.images){var n=new Image,P=new Image;n.src=buse_group_editor_settings.pluginUrl+"/images/group_perms_sprite.png";P.src=buse_group_editor_settings.pluginUrl+"/images/loading.gif"}n=b("#perm-panel-container").find(".perm-panel.active").first();n.length&&x(n);b("div#message").insertAfter(b("div.wrap h2:first"))});